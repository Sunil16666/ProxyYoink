name: Remove Unused Code

on:
  push:
    branches: [ main ]

jobs:
  remove-unused-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage
      - name: Run tests and generate coverage data
        run: |
          coverage run -m unittest discover
          coverage report
          coverage xml
          coverage html
      - name: Remove unused code
        if: ${{ github.event_name == 'push' && success() }}
        run: |
          coverage erase
          readarray -t files < <(git ls-files -m | grep .py)
          for file in "${files[@]}"
          do
            echo "Removing unused code in $file"
            coverage run $file > /dev/null
            coverage report $file | grep -v "^TOTAL$" | awk '{ print $2 }' | xargs sed -i '/^$/d'
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
